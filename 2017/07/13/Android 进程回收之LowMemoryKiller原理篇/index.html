<!DOCTYPE HTML>
<html>
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no">
    <link rel="dns-prefetch" href="//t11.baidu.com">
    <!--SEO-->



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->


<title>Android 进程回收之LowMemoryKiller原理篇 | 向志洪</title>


    <link rel="alternate" href="/atom.xml" title="向志洪" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css?rev=9.12.0">


<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css?rev=3.3.4">
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">
    <div class="hide">
    <script src="https://s4.cnzz.com/z_stat.php?id=1261768793&web_id=1262140174" language="JavaScript"></script>
    </div>
    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?13764659765";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
	
	<script src="https://cdn1.lncld.net/static/js/av-min-1.2.1.js"></script>
    <script>AV.initialize("aj42pgqDHRSVhMknqDb3JMeg-gzGzoHsz", "qbRaoHOP9NMWPOow8PandkH3");</script>
</head></html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header">
    <div class="main-header-box">
        <a class="branding" href="/" title="">
            <img src="/img/header_logo.png" alt="Snippet 博客主题">
        </a>
        <h2 class="text-hide">Snippet主题</h2>
        <img src="/img/header_logo.png" alt="Snippet 博客主题" class="hide">
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only">Toggle navigation</span>
                    <i class="fa fa-bars"></i>
                    </span>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class=""><a href="/">首页</a></li>
                        
                            <li role="presentation" class=""><a href="/categories/前端/">前端</a></li>
                        
                            <li role="presentation" class=""><a href="/categories/后端/">后端</a></li>
                        
                            <li role="presentation" class=""><a href="/categories/Java/">Java</a></li>
                        
                            <li role="presentation" class=""><a href="/categories/Python/">Python</a></li>
                        
                            <li role="presentation" class=""><a href="/categories/Android/">Android</a></li>
                        
                            <li role="presentation" class=""><a href="/categories/iOS/">iOS</a></li>
                        
                            <li role="presentation" class=""><a href="/categories/React Native/">React Native</a></li>
                        
                            <li role="presentation" class=""><a href="/categories/小程序/">小程序</a></li>
                        
                            <li role="presentation" class=""><a href="/categories/杂谈/">杂谈</a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Android 进程回收之LowMemoryKiller原理篇">
            
            Android 进程回收之LowMemoryKiller原理篇
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <span>Android</span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            Android
            
        </span>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">2017/07/13</span>
    </span>
</div>
            
            
    </div>
    
    <div class="post-body">
        <p>在前面的文章<a href="http://blog.csdn.net/xiangzhihong8/article/details/77919053" target="_blank" rel="external">Android进程保活</a>一文中，对于LowMemoryKiller的概念做了简单的提及。LowMemoryKiller简称低内存杀死机制。简单来说，LowMemoryKiller(低内存杀手)是Andorid基于oomKiller原理所扩展的一个多层次oomKiller，OOMkiller(Out Of Memory Killer)是在Linux系统无法分配新内存的时候，选择性杀掉进程，到oom的时候，系统可能已经不太稳定，而LowMemoryKiller是一种根据内存阈值级别触发的内存回收的机制，在系统可用内存较低时，就会选择性杀死进程的策略，相对OOMKiller，更加灵活。</p>
<p>在讲解LowMemoryKiller之前，先看另一个概念：OOMKiller。</p>
<p>Linux下有一种OOM KILLER 的机制，它会在系统内存耗尽的情况下，启用自己算法有选择性的kill 掉一些进程。</p>
<h1 id="OOMKiller"><a href="#OOMKiller" class="headerlink" title="OOMKiller"></a>OOMKiller</h1><p> 当我们启动应用时，需要向系统申请内存，即进行malloc的操作，进行malloc操作如果返回一个非NULL的操作表示申请到了可用的内部你。事实上，这个地方是可能存在bug的。Linux有一种内存优化机制，即：允许程序申请比系统可用内存更多的内存（术语：overcommit），但是Linux并不保证这些内存马上可用，如果凑巧你申请到的内存中在你需要使用的时候还没有完全释放出来，这个时候就会触发OOM killer了。内核代码为：mm/oom_kill.c，其调用顺序为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">malloc -&gt; _alloc_pages -&gt; out_of_memory() -&gt; select_bad_process() -&gt; badness()</div></pre></td></tr></table></figure>
<p>然而，系统的物理内存往往是有限的，这就需要在使用过程中杀掉一些无用的进程以腾出新的内存。在Android系统中，AmS需要和Linux操作系统有个约定，即将要谈到的Linux内核的内存管理控制系统是如何通知AMS内存不足的。</p>
<p>Java虚拟机运行时都有各自独立的内存空间，应用程序A发生Out Of Memory并不意味着应用程序B也会发生Out Of Memory，很有可能仅仅是A程序用光了自己内存的上限，而系统内存却还是有的。所以说，单纯的AmS是无法获知系统内存是否低的。</p>
<p>那么，Android系统是如何知道”系统内存低”或者”系统内存不够用”呢？从Android底层的Linux来讲，由于其并未采用磁盘虚拟内存机制，所以应用程序能够使用的内存大小完全取决于实际物理内存的大小，所以，”内存低”的含义就是实际物理内存已经被用得所剩无几了。看下面一幅图：<br><img src="http://img.blog.csdn.net/20170911093523283?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveGlhbmd6aGlob25nOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>在Android中运行了一个OOM 进程，即Out Of Memory。该进程启动时会首先向Linux内核中把自己注册为一个OOM Killer，即当Linux内核的内存管理模块检测到系统内存低的时候就会通知已经注册的OOM进程，然后这些OOM Killer就可以根据各种规则进行内存释放了，当然也可以什么都不做。</p>
<p>Android中的OOM Killer进程是仅仅适用于Android应用程序的，该进程在运行时，AmS需要把每一个应用程序的oom_adj值告知给Killer。这个值的范围在－16到15，值越低，说明越重要，这个值类似于Linux系统中的进程nice值，只是在标准的Linux中，有其自己的一套Killer机制。</p>
<p>重要：<strong>当发生低内存的条件时，Linux内核管理模块通知OOM Killer，Killer则根据AmS所告知的优先级，强制退出优先级低的应用进程。</strong></p>
<h1 id="LowMemoryKiller"><a href="#LowMemoryKiller" class="headerlink" title="LowMemoryKiller"></a>LowMemoryKiller</h1><p>前面，我们谈到了OOMKiller的一些知识，在理解OOMKiller的时候注意两点：</p>
<ol>
<li>LowMemoryKiller是被动杀死进程；</li>
<li>Android应用通过AMS，利用proc文件系统更新进程信息。</li>
</ol>
<h2 id="进程优先级及oomAdj"><a href="#进程优先级及oomAdj" class="headerlink" title="进程优先级及oomAdj"></a>进程优先级及oomAdj</h2><p>关于这方面的知识，前文有过介绍<a href="http://blog.csdn.net/xiangzhihong8/article/details/77919053" target="_blank" rel="external">Android进程保活</a>。这里在简单的介绍下。<br>Android会尽可能长时间地保持应用存活，但为了新建或运行更重要的进程，可能需要移除旧进程来回收内存，在选择要Kill的进程的时候，系统会根据进程的运行状态作出评估，权衡进程的“重要性“，其权衡的依据主要是四大组件。如果需要缩减内存，系统会首先消除重要性最低的进程，然后是重要性略逊的进程，依此类推，以回收系统资源。在Android中，应用进程划分5级：</p>
<ul>
<li>前台进程(Foreground process)</li>
<li>可见进程(Visible process)</li>
<li>服务进程(Service process)</li>
<li>后台进程(Background process)</li>
<li>空进程(Empty process)</li>
</ul>
<h3 id="前台进程-Foreground-process"><a href="#前台进程-Foreground-process" class="headerlink" title="前台进程(Foreground process)"></a>前台进程(Foreground process)</h3><p>用户当前操作所必需的进程。如果一个进程满足以下任一条件，即视为前台进程：</p>
<ul>
<li>包含正在交互的Activity（如resumed)</li>
<li>包含绑定到正在交互的Activity的Service</li>
<li>包含正在“前台”运行的Service（服务已调用startForeground()）</li>
<li>包含正执行一个生命周期回调的Service（onCreate()、onStart() 或 onDestroy()）</li>
<li>包含一个正执行其onReceive()方法的BroadcastReceiver</li>
</ul>
<h3 id="可见进程-Visible-process"><a href="#可见进程-Visible-process" class="headerlink" title="可见进程(Visible process)"></a>可见进程(Visible process)</h3><p>没有任何前台组件、但仍会影响用户在屏幕上所见内容的进程。 如果一个进程满足以下任一条件，即视为可见进程：<br>包含不在前台、但仍对用户可见的 Activity（已调用其 onPause() 方法）。例如，如果前台 Activity 启动了一个对话框，允许在其后显示上一Activity，则有可能会发生这种情况。<br>包含绑定到可见（或前台）Activity 的 Service。</p>
<h3 id="服务进程-Service-process"><a href="#服务进程-Service-process" class="headerlink" title="服务进程(Service process)"></a>服务进程(Service process)</h3><p>正在运行已使用 startService() 方法启动的服务且不属于上述两个更高类别进程的进程。尽管服务进程与用户所见内容没有直接关联，但是它们通常在执行一些用户关心的操作（例如，在后台播放音乐或从网络下载数据）。因此，除非内存不足以维持所有前台进程和可见进程同时运行，否则系统会让服务进程保持运行状态。</p>
<h3 id="后台进程-Background-process"><a href="#后台进程-Background-process" class="headerlink" title="后台进程(Background process)"></a>后台进程(Background process)</h3><p>包含目前对用户不可见的 Activity 的进程（已调用 Activity 的 onStop() 方法）。这些进程对用户体验没有直接影响，系统可能随时终止它们，以回收内存供前台进程、可见进程或服务进程使用。 通常会有很多后台进程在运行，因此它们会保存在 LRU （最近最少使用）列表中，以确保包含用户最近查看的 Activity 的进程最后一个被终止。如果某个 Activity 正确实现了生命周期方法，并保存了其当前状态，则终止其进程不会对用户体验产生明显影响，因为当用户导航回该 Activity 时，Activity会恢复其所有可见状态。</p>
<h3 id="空进程-Empty-process"><a href="#空进程-Empty-process" class="headerlink" title="空进程(Empty process)"></a>空进程(Empty process)</h3><p>不含任何活动应用组件的进程。保留这种进程的的唯一目的是用作缓存，以缩短下次在其中运行组件所需的启动时间，这就是所谓热启动 。为了使系统资源在进程缓存和底层内核缓存之间保持平衡，系统往往会终止这些进程。</p>
<p>根据进程中当前活动组件的重要程度，Android会对进程的优先级进行评定。下表是进程优先级的表(主要针对4.03-5.x)。</p>
<table><br>        <tr><br>            <th>adj级别</th><br>            <th>值</th><br>            <th>解释</th><br>        </tr><br>         <tr><br>            <th>UNKNOWN_ADJ</th><br>            <th>16</th><br>              <th>预留的最低级别，一般对于缓存的进程才有可能设置成这个级别</th><br>        </tr><br>         <tr><br>            <th>CACHED_APP_MAX_ADJ</th><br>            <th>15</th><br>              <th>缓存进程，空进程，在内存不足的情况下就会优先被kill</th><br>        </tr><br>       <tr><br>            <th>CACHED_APP_MIN_ADJ</th><br>            <th>9</th><br>              <th>缓存进程，也就是空进程</th><br>        </tr><br>         <tr><br>            <th>SERVICE_B_ADJ</th><br>            <th>8</th><br>              <th>不活跃的进程</th><br>        </tr><br>         <tr><br>            <th>PREVIOUS_APP_ADJ</th><br>            <th>7</th><br>              <th>切换进程</th><br>        </tr><br>         <tr><br>            <th>HOME_APP_ADJ</th><br>            <th>6</th><br>              <th>与Home交互的进程</th><br>        </tr><br>         <tr><br>            <th>SERVICE_ADJ</th><br>            <th>5</th><br>              <th>有Service的进程</th><br>        </tr><br>         <tr><br>            <th>HEAVY_WEIGHT_APP_ADJ</th><br>            <th>4</th><br>              <th>高权重进程</th><br>        </tr><br>         <tr><br>            <th>BACKUP_APP_ADJ</th><br>            <th>3</th><br>              <th>正在备份的进程</th><br>        </tr><br>          <tr><br>            <th>PERCEPTIBLE_APP_ADJ</th><br>            <th>2</th><br>              <th>可感知的进程，比如那种播放音乐</th><br>        </tr><br>        <tr><br>            <th>VISIBLE_APP_ADJ</th><br>            <th>1</th><br>              <th>可见进程，如当前的Activity</th><br>        </tr><br>        <tr><br>            <th>FOREGROUND_APP_ADJ</th><br>            <th>0</th><br>              <th>前台进程</th><br>        </tr><br>         <tr><br>            <th>PERSISTENT_SERVICE_ADJ</th><br>            <th>-11</th><br>              <th>重要进程</th><br>        </tr><br>         <tr><br>            <th>PERSISTENT_PROC_ADJ</th><br>            <th>-12</th><br>              <th>核心进程</th><br>        </tr><br>         <tr><br>            <th>SYSTEM_ADJ</th><br>            <th>-16</th><br>              <th>    系统进程</th><br>        </tr><br>        <tr><br>            <th>NATIVE_ADJ</th><br>            <th>-17</th><br>              <th>系统起的Native进程</th><br>        </tr><br></table>

<h2 id="android-优先级更新"><a href="#android-优先级更新" class="headerlink" title="android 优先级更新"></a>android 优先级更新</h2><p>APP中很多操作都可能会影响进程列表的优先级，比如退到后台、移到前台等，都会潜在的影响进程的优先级，我们知道Lowmemorykiller是通过遍历内核的进程结构体队列，选择优先级低的杀死，那么APP操作是如何写入到内核空间的呢？Linxu有用户间跟内核空间的区分，无论是APP还是系统服务，都是运行在用户空间，严格说用户控件的操作是无法直接影响内核空间的，更不用说更改进程的优先级。其实这里是通过了Linux中的一个proc文件体统，proc文件系统可以简单的看多是内核空间映射成用户可以操作的文件系统，当然不是所有进程都有权利操作，通过proc文件系统，用户空间的进程就能够修改内核空间的数据，比如修改进程的优先级，在Android家族，5.0之前的系统是AMS进程直接修改的，5.0之后，是修改优先级的操作被封装成了一个独立的服务-lmkd，lmkd服务位于用户空间，其作用层次同AMS、WMS类似，就是一个普通的系统服务。我们先看一下5.0之前的代码，这里仍然用4.3的源码看一下，模拟一个场景，APP只有一个Activity，我们主动finish掉这个Activity，APP就回到了后台，这里要记住，虽然没有可用的Activity，但是APP本身是没哟死掉的，这就是所谓的热启动，先看下大体的流程：<br><img src="http://img.blog.csdn.net/20170911105554171?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveGlhbmd6aGlob25nOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>以上面描述的push Activity为例，来查看AMS源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public final boolean finishActivity(IBinder token, int resultCode, Intent resultData) &#123;</div><div class="line">     ...</div><div class="line">    synchronized(this) &#123;</div><div class="line"></div><div class="line">        final long origId = Binder.clearCallingIdentity();</div><div class="line">        boolean res = mMainStack.requestFinishActivityLocked(token, resultCode,</div><div class="line">                resultData, &quot;app-request&quot;, true);</div><div class="line">     ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一开始的流程跟startActivity类似，首先是先暂停当前resume的Activity。相关代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">final boolean finishActivityLocked(ActivityRecord r, int index, int resultCode,</div><div class="line">            Intent resultData, String reason, boolean immediate, boolean oomAdj) &#123;</div><div class="line">         ...</div><div class="line">            if (mPausingActivity == null) &#123;</div><div class="line">                if (DEBUG_PAUSE) Slog.v(TAG, &quot;Finish needs to pause: &quot; + r);</div><div class="line">                if (DEBUG_USER_LEAVING) Slog.v(TAG, &quot;finish() =&gt; pause with userLeaving=false&quot;);</div><div class="line">                startPausingLocked(false, false);</div><div class="line">            &#125;</div><div class="line">            ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>pause掉当前Activity之后，还需要唤醒上一个Activity，如果当前APP的Activity栈里应经空了，就回退到上一个应用或者桌面程序。对于返回到桌面的情况这里不做深究。其实源码有一段代码是判断，当前的ActivityStack上面是否还有其他的Activity的代码。当Activity回退到后台状态后，系统做了什么事情呢？来看下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">private final void completePauseLocked() &#123;</div><div class="line">   ActivityRecord prev = mPausingActivity;</div><div class="line"></div><div class="line">   if (prev != null) &#123;</div><div class="line">       if (prev.finishing) &#123;</div><div class="line">       1、 不同点</div><div class="line">      &lt;!--主动finish的时候，走的是这个分支，状态变换的细节请自己查询代码--&gt;</div><div class="line">           prev = finishCurrentActivityLocked(prev, FINISH_AFTER_VISIBLE, false);</div><div class="line">       &#125; </div><div class="line">       ...</div><div class="line">       2、相同点       </div><div class="line">    if (!mService.isSleeping()) &#123;</div><div class="line">       resumeTopActivityLocked(prev);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>看一下上面的两个关键点1跟2，1是同startActivity的completePauseLocked不同的地方，主动finish的prev.finishing是为true的，因此会执行finishCurrentActivityLocked分支，将当前pause的Activity加到mStoppingActivities队列中去，并且唤醒下一个需要走到到前台的Activity，唤醒后，会继续执行stop：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">private final ActivityRecord finishCurrentActivityLocked(ActivityRecord r,</div><div class="line">           int index, int mode, boolean oomAdj) &#123;</div><div class="line">       if (mode == FINISH_AFTER_VISIBLE &amp;&amp; r.nowVisible) &#123;</div><div class="line">           if (!mStoppingActivities.contains(r)) &#123;</div><div class="line">               mStoppingActivities.add(r);</div><div class="line">               ...</div><div class="line">           &#125;</div><div class="line">              ....</div><div class="line">           return r;</div><div class="line">       &#125;</div><div class="line">       ...</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>再回到resumeTopActivityLocked继续看，resume之后会回调completeResumeLocked函数，继续执行stop，这个函数通过向Handler发送IDLE_TIMEOUT_MSG消息来回调activityIdleInternal函数，最终执行destroyActivityLocked销毁ActivityRecord。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">final boolean resumeTopActivityLocked(ActivityRecord prev, Bundle options) &#123;</div><div class="line">        ...</div><div class="line">   if (next.app != null &amp;&amp; next.app.thread != null) &#123;                   ...</div><div class="line">            try &#123;</div><div class="line">                。。。</div><div class="line">                next.app.thread.scheduleResumeActivity(next.appToken,</div><div class="line">                        mService.isNextTransitionForward());</div><div class="line">                ..。</div><div class="line">            try &#123;</div><div class="line">                next.visible = true;</div><div class="line">                completeResumeLocked(next);</div><div class="line">            &#125;  </div><div class="line">            ....</div><div class="line">         &#125;</div></pre></td></tr></table></figure>
<p>在销毁Activity的时候，如果当前APP的Activity堆栈为空了，就说明当前Activity没有可见界面了，这个时候就需要动态更新这个APP的优先级，详细代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">final boolean destroyActivityLocked(ActivityRecord r,</div><div class="line">           boolean removeFromApp, boolean oomAdj, String reason) &#123;</div><div class="line">           ...</div><div class="line">      if (hadApp) &#123;</div><div class="line">           if (removeFromApp) &#123;</div><div class="line">               // 这里动ProcessRecord里面删除，但是没从history删除</div><div class="line">               int idx = r.app.activities.indexOf(r);</div><div class="line">               if (idx &gt;= 0) &#123;</div><div class="line">                   r.app.activities.remove(idx);</div><div class="line">               &#125;</div><div class="line">               ...</div><div class="line">               if (r.app.activities.size() == 0) &#123;</div><div class="line">                   // No longer have activities, so update oom adj.</div><div class="line">                   mService.updateOomAdjLocked();</div><div class="line">               ...</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>最终会调用AMS的updateOomAdjLocked函数去更新进程优先级，在4.3的源码里面，主要是通过Process类的setOomAdj函数来设置优先级。ActivityManagerService更新优先级的代码在updateOomAdjLocked里面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">private final boolean updateOomAdjLocked(ProcessRecord app, int hiddenAdj,</div><div class="line">        int clientHiddenAdj, int emptyAdj, ProcessRecord TOP_APP, boolean doingAll) &#123;</div><div class="line">    ...</div><div class="line">    计算优先级</div><div class="line">    computeOomAdjLocked(app, hiddenAdj, clientHiddenAdj, emptyAdj, TOP_APP, false, doingAll);</div><div class="line">     。。。</div><div class="line">     &lt;!--如果不相同，设置新的OomAdj--&gt;</div><div class="line"></div><div class="line">    if (app.curAdj != app.setAdj) &#123;</div><div class="line">        if (Process.setOomAdj(app.pid, app.curAdj)) &#123;</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后调用android_util_Process.cpp，通过proc文件系统修改内核信息来动态更新进程的优先级oomAdj，以上是针对Android4.3系统的分析。<br><img src="http://img.blog.csdn.net/20170911110910100?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveGlhbmd6aGlob25nOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="Android-5-0的进程优先级更新-LMKD服务"><a href="#Android-5-0的进程优先级更新-LMKD服务" class="headerlink" title="Android 5.0的进程优先级更新-LMKD服务"></a>Android 5.0的进程优先级更新-LMKD服务</h3><p>Android5.0将设置进程优先级的入口封装成了一个独立的服务lmkd服务，AMS不再直接访问proc文件系统，而是通过lmkd服务来进行设置，从init.rc文件中看到服务的配置。相关配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">service lmkd /system/bin/lmkd</div><div class="line">    class core</div><div class="line">    critical</div><div class="line">    socket lmkd seqpacket 0660 system system</div></pre></td></tr></table></figure>
<p>从配置中可以看出，该服务是通过socket与其他进行进程进行通信，其实就是AMS通过socket向lmkd服务发送请求，让lmkd去更新进程的优先级，lmkd收到请求后，会通过/proc文件系统去更新内核中的进程优先级。首先看一下5.0中这一块AMS有什么改变。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">private final boolean updateOomAdjLocked(ProcessRecord app, int cachedAdj,</div><div class="line">        ProcessRecord TOP_APP, boolean doingAll, long now) &#123;</div><div class="line">    ...</div><div class="line">    computeOomAdjLocked(app, cachedAdj, TOP_APP, doingAll, now);</div><div class="line">    ...</div><div class="line">    applyOomAdjLocked(app, doingAll, now, SystemClock.elapsedRealtime());</div><div class="line">&#125;</div><div class="line"></div><div class="line">private final boolean applyOomAdjLocked(ProcessRecord app, boolean doingAll, long now,</div><div class="line">        long nowElapsed) &#123;</div><div class="line">    boolean success = true;</div><div class="line"></div><div class="line">    if (app.curRawAdj != app.setRawAdj) &#123;</div><div class="line">        app.setRawAdj = app.curRawAdj;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    int changes = 0;</div><div class="line">      不同点1</div><div class="line">    if (app.curAdj != app.setAdj) &#123;</div><div class="line">        ProcessList.setOomAdj(app.pid, app.info.uid, app.curAdj);</div><div class="line">        if (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</div><div class="line">                &quot;Set &quot; + app.pid + &quot; &quot; + app.processName + &quot; adj &quot; + app.curAdj + &quot;: &quot;</div><div class="line">                + app.adjType);</div><div class="line">        app.setAdj = app.curAdj;</div><div class="line">        app.verifiedAdj = ProcessList.INVALID_ADJ;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上面的不同点1可以看出，5.0之后是通过ProcessList类去设置oomAdj，其实这里就是通过socket与LMKD服务进行通信，向lmkd服务传递给LMK_PROCPRIO命令去更新进程优先级：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public static final void setOomAdj(int pid, int uid, int amt) &#123;</div><div class="line">    if (amt == UNKNOWN_ADJ)</div><div class="line">        return;</div><div class="line">   long start = SystemClock.elapsedRealtime();</div><div class="line">    ByteBuffer buf = ByteBuffer.allocate(4 * 4);</div><div class="line">    buf.putInt(LMK_PROCPRIO);</div><div class="line">    buf.putInt(pid);</div><div class="line">    buf.putInt(uid);</div><div class="line">    buf.putInt(amt);</div><div class="line">    writeLmkd(buf);</div><div class="line">    long now = SystemClock.elapsedRealtime();</div><div class="line">      &#125;    </div><div class="line"></div><div class="line">private static void writeLmkd(ByteBuffer buf) &#123;</div><div class="line">        for (int i = 0; i &lt; 3; i++) &#123;</div><div class="line">        if (sLmkdSocket == null) &#123;</div><div class="line">          if (openLmkdSocket() == false) &#123;</div><div class="line">            ...</div><div class="line">        try &#123;</div><div class="line">            sLmkdOutputStream.write(buf.array(), 0, buf.position());</div><div class="line">            return;</div><div class="line">            ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>其实就是openLmkdSocket打开本地socket端口，并将优先级信息发送过去，那么lmkd服务端如何处理的呢，来看看lmkd服务的入口main函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">int main(int argc __unused, char **argv __unused) &#123;</div><div class="line">    struct sched_param param = &#123;</div><div class="line">            .sched_priority = 1,</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    mlockall(MCL_FUTURE);</div><div class="line">    sched_setscheduler(0, SCHED_FIFO, &amp;param);</div><div class="line">    if (!init())</div><div class="line">        mainloop();</div><div class="line"></div><div class="line">    ALOGI(&quot;exiting&quot;);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很简单，打开一个端口，并通过mainloop监听socket，如果有请求到来，就解析命令并执行，刚才传入的LMK_PROCPRIO命令对应的操作就是cmd_procprio，用来更新oomAdj，其更新新机制还是通过proc文件系统。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">static void cmd_procprio(int pid, int uid, int oomadj) &#123;</div><div class="line">    struct proc *procp;</div><div class="line">    。。。</div><div class="line">    还是利用/proc文件系统进行更新</div><div class="line">    snprintf(path, sizeof(path), &quot;/proc/%d/oom_score_adj&quot;, pid);</div><div class="line">    snprintf(val, sizeof(val), &quot;%d&quot;, lowmem_oom_adj_to_oom_score_adj(oomadj));</div><div class="line">    writefilestring(path, val);</div><div class="line">   。。。</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与4.3版本相比，5.0的LMKD简化了很多AMS的东西。<br><img src="http://img.blog.csdn.net/20170911111518785?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveGlhbmd6aGlob25nOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="LomemoryKiller内核区块"><a href="#LomemoryKiller内核区块" class="headerlink" title="LomemoryKiller内核区块"></a>LomemoryKiller内核区块</h2><p>LomemoryKiller属于一个内核驱动模块，主要功能是：在系统内存不足的时候扫描进程队列，找到低优先级（也许说性价比低更合适）的进程并杀死，以达到释放内存的目的。对于驱动程序，入口是__init函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">static int __init lowmem_init(void)</div><div class="line">&#123;</div><div class="line">    register_shrinker(&amp;lowmem_shrinker);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LomemoryKiller将自己的lowmem_shrinker入口注册到系统的内存检测模块去，作用就是在内存不足的时候可以被回调，register_shrinker函数是一属于另一个内存管理模块的函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">void register_shrinker(struct shrinker *shrinker)</div><div class="line">&#123;</div><div class="line">    shrinker-&gt;nr = 0;</div><div class="line">    down_write(&amp;shrinker_rwsem);</div><div class="line">    list_add_tail(&amp;shrinker-&gt;list, &amp;shrinker_list);</div><div class="line">    up_write(&amp;shrinker_rwsem);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，看一下，当内存不足触发回调的时候，LomemoryKiller是如何找到低优先级进程，并杀死的。管家代码就在lowmem_shrink函数里面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">static int lowmem_shrink(int nr_to_scan, gfp_t gfp_mask)</div><div class="line">&#123;</div><div class="line">    struct task_struct *p;</div><div class="line">    。。。</div><div class="line">    关键点1 找到当前的内存对应的阈值</div><div class="line">    for(i = 0; i &lt; array_size; i++) &#123;</div><div class="line">        if (other_free &lt; lowmem_minfree[i] &amp;&amp;</div><div class="line">            other_file &lt; lowmem_minfree[i]) &#123;</div><div class="line">            min_adj = lowmem_adj[i];</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    。。。</div><div class="line">    关键点2 找到优先级低于这个阈值的进程，并杀死</div><div class="line"></div><div class="line">    read_lock(&amp;tasklist_lock);</div><div class="line">    for_each_process(p) &#123;</div><div class="line">        if (p-&gt;oomkilladj &lt; min_adj || !p-&gt;mm)</div><div class="line">            continue;</div><div class="line">        tasksize = get_mm_rss(p-&gt;mm);</div><div class="line">        if (tasksize &lt;= 0)</div><div class="line">            continue;</div><div class="line">        if (selected) &#123;</div><div class="line">            if (p-&gt;oomkilladj &lt; selected-&gt;oomkilladj)</div><div class="line">                continue;</div><div class="line">            if (p-&gt;oomkilladj == selected-&gt;oomkilladj &amp;&amp;</div><div class="line">                tasksize &lt;= selected_tasksize)</div><div class="line">                continue;</div><div class="line">        &#125;</div><div class="line">        selected = p;</div><div class="line">        selected_tasksize = tasksize;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    if(selected != NULL) &#123;</div><div class="line">        force_sig(SIGKILL, selected);</div><div class="line">        rem -= selected_tasksize;</div><div class="line">    &#125;</div><div class="line">    lowmem_print(4, &quot;lowmem_shrink %d, %x, return %d\n&quot;, nr_to_scan, gfp_mask, rem);</div><div class="line">    read_unlock(&amp;tasklist_lock);</div><div class="line">    return rem;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的逻辑很清楚，通过给应用设置内存对应的阈值，通过Linux的中的信号量，发送SIGKILL信号直接将进程杀死。关于LomemoryKiller和Linux底层通信的原理，请大家自行学习相关的文章介绍。</p>
<p>附：<a href="http://blog.csdn.net/gaugamela/article/details/54176460" target="_blank" rel="external"> Android 7.0 ActivityManagerService分析</a></p>
    </div>

    <div class="post-footer">   
        <div>
            
                转载声明: 商业转载请联系作者获得授权,非商业转载请注明出处 © Snippet
            
        </div>
        <div>
            
                版权声明: <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank">
知识共享署名-非商业性使用-禁止演绎 3.0 未本地化版本许可协议（CC BY-NC-ND 3.0）
</a>
            
        </div>  
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2017/07/14/前端ThinkJS框架解析/" class="pre-post btn btn-default"><i class="fa fa-angle-left fa-fw"></i>上一篇</a>
    
    
        <a href="/2017/07/13/使用Gitbook写电子书/" class="next-post btn btn-default">下一篇<i class="fa fa-angle-right fa-fw"></i></a>
    
</div>


    <div id="comments">
        <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2120654"></script>
    </div>
                </main>
                <aside class="col-md-4 sidebar">
        
        <div class="widget notification">
        <h3 class="title">网站公告</h3>
        <div>
            <p>主题Snippet v1.1.0版本即将上线，敬请期待~ <br>
主题下载：<a href="https://github.com/shenliyang/hexo-theme-snippet" title="fork me" target="_blank">Snippet主题</a> <br>
<hr>前端工程师一枚，专注于前端Node、React和移动端Android和Ios开发，欢迎骚扰。
<br>联系方式：qq群:278792776（移动群）、515980159（React群）、188716429（猎头hr群）
</p>
        </div>
    </div>
        
        <div class="widget">
        <h3 class="title">分类</h3>
        <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/"><i class="fa" aria-hidden="true">Android</i></a><span class="category-list-count">41</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/系统/"><i class="fa" aria-hidden="true">系统</i></a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Google/"><i class="fa" aria-hidden="true">Google</i></a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Google/VR/"><i class="fa" aria-hidden="true">VR</i></a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/"><i class="fa" aria-hidden="true">Java</i></a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/"><i class="fa" aria-hidden="true">Kotlin</i></a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWA/"><i class="fa" aria-hidden="true">PWA</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/"><i class="fa" aria-hidden="true">Python</i></a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/React-Native/"><i class="fa" aria-hidden="true">React Native</i></a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/"><i class="fa" aria-hidden="true">Spring</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android/"><i class="fa" aria-hidden="true">android</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/"><i class="fa" aria-hidden="true">iOS</i></a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ios/"><i class="fa" aria-hidden="true">ios</i></a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/"><i class="fa" aria-hidden="true">python</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/人工智能/"><i class="fa" aria-hidden="true">人工智能</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/"><i class="fa" aria-hidden="true">前端</i></a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/区块链/"><i class="fa" aria-hidden="true">区块链</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后端/"><i class="fa" aria-hidden="true">后端</i></a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/小程序/"><i class="fa" aria-hidden="true">小程序</i></a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术人生/"><i class="fa" aria-hidden="true">技术人生</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/"><i class="fa" aria-hidden="true">机器学习</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂谈/"><i class="fa" aria-hidden="true">杂谈</i></a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/"><i class="fa" aria-hidden="true">编程语言</i></a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/"><i class="fa" aria-hidden="true">设计模式</i></a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/资料库/"><i class="fa" aria-hidden="true">资料库</i></a><span class="category-list-count">1</span></li></ul>
    </div>
        
        <div class="widget">
      <h3 class="title">归档</h3>
        <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/"><i class="fa" aria-hidden="true">二月 2018</i></a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/"><i class="fa" aria-hidden="true">一月 2018</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/"><i class="fa" aria-hidden="true">十二月 2017</i></a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/"><i class="fa" aria-hidden="true">十一月 2017</i></a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/"><i class="fa" aria-hidden="true">十月 2017</i></a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/"><i class="fa" aria-hidden="true">九月 2017</i></a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/"><i class="fa" aria-hidden="true">八月 2017</i></a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/"><i class="fa" aria-hidden="true">七月 2017</i></a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/"><i class="fa" aria-hidden="true">六月 2017</i></a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/"><i class="fa" aria-hidden="true">五月 2017</i></a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/"><i class="fa" aria-hidden="true">四月 2017</i></a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/"><i class="fa" aria-hidden="true">三月 2017</i></a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/"><i class="fa" aria-hidden="true">二月 2017</i></a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/"><i class="fa" aria-hidden="true">一月 2017</i></a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/"><i class="fa" aria-hidden="true">十二月 2016</i></a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/"><i class="fa" aria-hidden="true">十一月 2016</i></a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/"><i class="fa" aria-hidden="true">十月 2016</i></a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/"><i class="fa" aria-hidden="true">九月 2016</i></a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/"><i class="fa" aria-hidden="true">八月 2016</i></a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/"><i class="fa" aria-hidden="true">七月 2016</i></a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/"><i class="fa" aria-hidden="true">六月 2016</i></a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/"><i class="fa" aria-hidden="true">五月 2016</i></a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/"><i class="fa" aria-hidden="true">四月 2016</i></a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/"><i class="fa" aria-hidden="true">三月 2016</i></a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/"><i class="fa" aria-hidden="true">二月 2016</i></a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/"><i class="fa" aria-hidden="true">一月 2016</i></a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/"><i class="fa" aria-hidden="true">九月 2015</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/"><i class="fa" aria-hidden="true">六月 2015</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/"><i class="fa" aria-hidden="true">五月 2015</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/"><i class="fa" aria-hidden="true">四月 2015</i></a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/"><i class="fa" aria-hidden="true">三月 2015</i></a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/"><i class="fa" aria-hidden="true">一月 2015</i></a><span class="archive-list-count">1</span></li></ul>
    </div>
        
        <div class="widget">
    <h3 class="title">标签云</h3>
    <div class="content tag-cloud">
      
        <a href="/tags/Spring/" style="font-size: 1em">Spring</a> <a href="/tags/前端/" style="font-size: 1em">前端</a> <a href="/tags/Android/" style="font-size: 1em">Android</a> <a href="/tags/新特性/" style="font-size: 1em">新特性</a> <a href="/tags/深入系统/" style="font-size: 1em">深入系统</a> <a href="/tags/系统服务/" style="font-size: 1em">系统服务</a> <a href="/tags/android/" style="font-size: 1em">android</a> <a href="/tags/混淆打包/" style="font-size: 1em">混淆打包</a> <a href="/tags/硬件/" style="font-size: 1em">硬件</a> <a href="/tags/Angular2/" style="font-size: 1em">Angular2</a> <a href="/tags/前端开发/" style="font-size: 1em">前端开发</a> <a href="/tags/iOS/" style="font-size: 1em">iOS</a> <a href="/tags/React-Native/" style="font-size: 1em">React Native</a> <a href="/tags/FlexBox布局/" style="font-size: 1em">FlexBox布局</a> <a href="/tags/Google/" style="font-size: 1em">Google</a> <a href="/tags/VR/" style="font-size: 1em">VR</a> <a href="/tags/小程序/" style="font-size: 1em">小程序</a> <a href="/tags/后端/" style="font-size: 1em">后端</a> <a href="/tags/Java/" style="font-size: 1em">Java</a> <a href="/tags/垃圾回收/" style="font-size: 1em">垃圾回收</a> <a href="/tags/Kotlin/" style="font-size: 1em">Kotlin</a> <a href="/tags/编程语言/" style="font-size: 1em">编程语言</a> <a href="/tags/Node/" style="font-size: 1em">Node</a> <a href="/tags/OpenGL/" style="font-size: 1em">OpenGL</a> <a href="/tags/Promise/" style="font-size: 1em">Promise</a> <a href="/tags/eact-Native/" style="font-size: 1em">eact Native</a> <a href="/tags/原生/" style="font-size: 1em">原生</a> <a href="/tags/调试/" style="font-size: 1em">调试</a> <a href="/tags/打包/" style="font-size: 1em">打包</a> <a href="/tags/Python/" style="font-size: 1em">Python</a> <a href="/tags/入门/" style="font-size: 1em">入门</a> <a href="/tags/ios/" style="font-size: 1em">ios</a> <a href="/tags/swift/" style="font-size: 1em">swift</a> <a href="/tags/Swift/" style="font-size: 1em">Swift</a> <a href="/tags/AR/" style="font-size: 1em">AR</a> <a href="/tags/知识库/" style="font-size: 1em">知识库</a> <a href="/tags/Xcode/" style="font-size: 1em">Xcode</a> <a href="/tags/webpack/" style="font-size: 1em">webpack</a> <a href="/tags/gulp/" style="font-size: 1em">gulp</a> <a href="/tags/https/" style="font-size: 1em">https</a> <a href="/tags/gif/" style="font-size: 1em">gif</a> <a href="/tags/mac/" style="font-size: 1em">mac</a> <a href="/tags/环境/" style="font-size: 1em">环境</a> <a href="/tags/原理/" style="font-size: 1em">原理</a> <a href="/tags/react/" style="font-size: 1em">react</a> <a href="/tags/杂谈/" style="font-size: 1em">杂谈</a> <a href="/tags/个人博客/" style="font-size: 1em">个人博客</a> <a href="/tags/流量/" style="font-size: 1em">流量</a> <a href="/tags/区块链/" style="font-size: 1em">区块链</a> <a href="/tags/微信/" style="font-size: 1em">微信</a> <a href="/tags/全栈/" style="font-size: 1em">全栈</a> <a href="/tags/搭建网站/" style="font-size: 1em">搭建网站</a> <a href="/tags/机器学习/" style="font-size: 1em">机器学习</a> <a href="/tags/算法/" style="font-size: 1em">算法</a> <a href="/tags/深入理解/" style="font-size: 1em">深入理解</a> <a href="/tags/内存分配/" style="font-size: 1em">内存分配</a> <a href="/tags/PWA/" style="font-size: 1em">PWA</a> <a href="/tags/人工智能/" style="font-size: 1em">人工智能</a> <a href="/tags/设计模式/" style="font-size: 1em">设计模式</a>
    </div>
  </div>
        
        <div class="widget">
        <h3 class="title">友链</h3>
        <div class="content friends-link">
        
            <a href="http://blog.csdn.net/xiangzhihong8/" class="fa" target="_blank">作者博客</a>
        
            <a href="https://yq.aliyun.com/u/xiangzhihong" class="fa" target="_blank">阿里云博客</a>
        
        </div>
    </div>
        
    </aside>
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<!--page counter part-->
<script>
function addCount (Counter) {
        url=$('.article-date').attr('href').trim();
        title = $('.article-title').text().trim();
        var query=new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url",url);
        query.find({
            success: function(results){
                if(results.length>0)
                {
                    var counter=results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                }
                else
                {
                    var newcounter=new Counter();
                    newcounter.set("title",title);
                    newcounter.set("url",url);
                    newcounter.set("time",1);
                    newcounter.save(null,{
                        success: function(newcounter){
                        //alert('New object created');
                        },
                        error: function(newcounter,error){
                        alert('Failed to create');
                        }
                        });
                }
            },
            error: function(error){
                //find null is not a error
                alert('Error:'+error.code+" "+error.message);
            }
        });
}
$(function(){
        var Counter=AV.Object.extend("Counter");
        //only increse visit counting when intering a page
        if ($('.article-title').length == 1)
           addCount(Counter);
        var query=new AV.Query(Counter);
        query.descending("time");
        // the sum of popular posts
        query.limit(10); 
        query.find({
            success: function(results){
                    for(var i=0;i<results.length;i++)    
                    {
                        var counter=results[i];
                        title=counter.get("title");
                        url=counter.get("url");
                        time=counter.get("time");
                        // add to the popularlist widget
                        showcontent=title+" ("+time+")";
                        //notice the "" in href
                        $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                    }
                },
            error: function(error){
                alert("Error:"+error.code+" "+error.message);
            }
            }
        )
        });
</script>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12"> 
                <span>Copyright &copy; 2017 
                </span> | 
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> | 
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>
<script src="/assets/highlight.pack.js?rev=@@hash"></script>
  <script>
    hljs.initHighlightingOnLoad(); //初始化代码高亮 
  </script>

<script src="/js/app.js?rev=@@hash"></script>
</body>
